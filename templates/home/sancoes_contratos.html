{% extends "layouts/base.html" %}

{% block title %} Sanções vs Contratos {% endblock %}

{% block content %}
<div class="content">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title mb-2">Análise: Sanções vs Contratos</h3>
          <p class="card-category mb-0">Empresas sancionadas que firmaram contratos durante período de sanção ativa</p>
        </div>
      </div>
    </div>
  </div>

  {% if dados %}
  <!-- Resumo -->
  <div class="row">
    <div class="col-md-3">
      <div class="card card-stats">
        <div class="card-body">
          <div class="row">
            <div class="col-12">
              <div class="numbers text-center">
                <p class="card-category">Total de Sanções</p>
                <h2 class="card-title">{{ dados.total_sancoes }}</h2>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-stats">
        <div class="card-body">
          <div class="row">
            <div class="col-12">
              <div class="numbers text-center">
                <p class="card-category">Total de Contratos</p>
                <h2 class="card-title">{{ dados.total_contratos }}</h2>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-stats">
        <div class="card-body">
          <div class="row">
            <div class="col-12">
              <div class="numbers text-center">
                <p class="card-category">Irregularidades</p>
                <h2 class="card-title text-danger">{{ dados.total_irregularidades }}</h2>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-stats">
        <div class="card-body">
          <div class="row">
            <div class="col-12">
              <div class="numbers text-center">
                <p class="card-category">% Irregular</p>
                <h2 class="card-title text-warning">{{ "%.2f"|format(dados.percentual_irregular) }}%</h2>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráfico de Valores -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h4 class="card-title">Distribuição de Valores</h4>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p class="mb-1"><strong>Valor Total de Contratos:</strong></p>
              <h3 class="text-success">R$ {{ "{:,.2f}".format(dados.valor_total_contratos).replace(',', 'X').replace('.', ',').replace('X', '.') }}</h3>
            </div>
            <div class="col-md-6">
              <p class="mb-1"><strong>Valor Irregular:</strong></p>
              <h3 class="text-danger">R$ {{ "{:,.2f}".format(dados.valor_irregular).replace(',', 'X').replace('.', ',').replace('X', '.') }}</h3>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabela de Empresas Irregulares -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h4 class="card-title">Empresas com Contratos Durante Sanção</h4>
          <p class="card-category">Detalhamento por empresa</p>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>#</th>
                  <th>CNPJ/CPF</th>
                  <th>Nome</th>
                  <th class="text-center">Nº Contratos</th>
                  <th class="text-right">Valor Total</th>
                  <th class="text-center">Ações</th>
                </tr>
              </thead>
              <tbody>
                {% for empresa in dados.empresas_irregulares %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td><code>{{ empresa.cpf_cnpj }}</code></td>
                  <td>{{ empresa.nome }}</td>
                  <td class="text-center">
                    <span class="badge badge-danger">{{ empresa.contratos|length }}</span>
                  </td>
                  <td class="text-right">
                    <strong>R$ {{ "{:,.2f}".format(empresa.valor_total).replace(',', 'X').replace('.', ',').replace('X', '.') }}</strong>
                  </td>
                  <td class="text-center">
                    <button class="btn btn-sm btn-info" 
                            onclick="verDetalhes('{{ empresa.cpf_cnpj }}', '{{ empresa.nome }}', {{ empresa.contratos|tojson }})"
                            data-toggle="modal" 
                            data-target="#modalDetalhes">
                      <i class="tim-icons icon-zoom-split"></i> Ver Detalhes
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabela de Todas as Irregularidades -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h4 class="card-title">Todas as Irregularidades Detectadas</h4>
          <p class="card-category">Lista completa de contratos firmados durante sanção</p>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="text-primary">
                <tr>
                  <th>#</th>
                  <th>Empresa</th>
                  <th>Nº Contrato</th>
                  <th>Órgão</th>
                  <th class="text-right">Valor</th>
                  <th>Data Contrato</th>
                  <th>Tipo Sanção</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for irreg in dados.irregularidades %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>
                    <small>{{ irreg.nome }}</small><br>
                    <code style="font-size: 10px;">{{ irreg.cpf_cnpj }}</code>
                  </td>
                  <td><small>{{ irreg.numero_contrato }}</small></td>
                  <td><small>{{ irreg.orgao_contratante }}</small></td>
                  <td class="text-right">
                    <strong>R$ {{ "{:,.2f}".format(irreg.valor_contrato).replace(',', 'X').replace('.', ',').replace('X', '.') }}</strong>
                  </td>
                  <td><small>{{ irreg.data_contrato }}</small></td>
                  <td><span class="badge badge-warning">{{ irreg.tipo_sancao }}</span></td>
                  <td><span class="badge badge-danger">{{ irreg.status }}</span></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% elif erro %}
  <div class="row">
    <div class="col-12">
      <div class="alert alert-danger">
        <strong>Erro:</strong> {{ erro }}
      </div>
    </div>
  </div>
  {% else %}
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body text-center py-5">
          <i class="tim-icons icon-alert-circle-exc" style="font-size: 64px; color: #888;"></i>
          <h3 class="mt-3">Nenhum dado disponível</h3>
          <p class="text-muted">Importe dados de CEIS e contratos para realizar a análise.</p>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Modal de Detalhes -->
<div class="modal fade" id="modalDetalhes" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalhes da Empresa</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <h4 id="modalNomeEmpresa"></h4>
        <p><strong>CNPJ/CPF:</strong> <code id="modalCpfCnpj"></code></p>
        <hr>
        <h5>Contratos Irregulares:</h5>
        <div id="modalContratos"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block javascripts %}
<script>
function verDetalhes(cpfCnpj, nome, contratos) {
  document.getElementById('modalCpfCnpj').textContent = cpfCnpj;
  document.getElementById('modalNomeEmpresa').textContent = nome;
  
  let html = '<div class="table-responsive"><table class="table table-sm">';
  html += '<thead><tr><th>Nº Contrato</th><th>Órgão</th><th>Valor</th><th>Data</th><th>Sanção</th></tr></thead>';
  html += '<tbody>';
  
  contratos.forEach(function(c, idx) {
    let valor = parseFloat(c.valor_contrato).toLocaleString('pt-BR', {minimumFractionDigits: 2});
    html += `<tr>
      <td>${c.numero_contrato}</td>
      <td><small>${c.orgao_contratante}</small></td>
      <td>R$ ${valor}</td>
      <td>${c.data_contrato}</td>
      <td><span class="badge badge-warning">${c.tipo_sancao}</span></td>
    </tr>`;
  });
  
  html += '</tbody></table></div>';
  document.getElementById('modalContratos').innerHTML = html;
}
</script>
{% endblock %}
